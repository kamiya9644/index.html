<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>作業報告</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:16px; line-height:1.4;}
    h1{font-size:18px;margin:0 0 12px;}
    .card{border:1px solid #ddd; border-radius:10px; padding:12px; margin:10px 0;}
    label{display:block; font-size:12px; color:#555; margin:8px 0 4px;}
    input, select, textarea{width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px;}
    textarea{min-height:110px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .row{display:flex; gap:10px;}
    .row > div{flex:1;}
    .muted{color:#666; font-size:12px;}
    .ok{color:#0a7a0a;}
    .ng{color:#b00020;}
    .btn{padding:10px 12px; border-radius:10px; border:1px solid #333; background:#111; color:#fff; cursor:pointer;}
    .btn.secondary{background:#fff; color:#111; border-color:#aaa;}
    .btn.danger{background:#b00020; border-color:#b00020;}
    .btn:disabled{opacity:.5; cursor:not-allowed;}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .small{font-size:12px;}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; margin-left:6px;}
    .footer{margin-top:14px;}
    .hr{height:1px;background:#eee;margin:12px 0;}
  </style>
</head>
<body>
  <h1>作業報告（LIFF）</h1>
  <div class="muted">日付・店舗は1回、作業×車種ごとにIDをまとめて送れます（10桁チェックあり）</div>

  <div class="card">
    <div class="row">
      <div>
        <label>作業日</label>
        <input type="date" id="workDate">
      </div>
      <div>
        <label>店舗</label>
        <select id="storeSelect"></select>
      </div>
    </div>
    <div class="muted small" id="userInfo"></div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <b>作業グループ</b>
        <span class="pill small" id="groupCount">0</span>
      </div>
      <button class="btn secondary" id="addGroupBtn" type="button">＋グループ追加</button>
    </div>
    <div class="hr"></div>
    <div id="groups"></div>
  </div>

  <div class="footer">
    <div class="muted" id="summary"></div>
    <div class="actions">
      <button class="btn" id="submitBtn" type="button" disabled>送信</button>
      <button class="btn secondary" id="closeBtn" type="button">閉じる</button>
    </div>
    <pre class="muted small" id="result"></pre>
  </div>

<script>
  // ========= あなたの環境に合わせてここだけ差し替え =========
  const LIFF_ID = "2008808765-L8j70RxD";
  const MAKE_WEBHOOK_URL = "https://hook.eu1.make.com/lyun7f40ey1ceh4yxhaio55gubjvpis8";

  // 店舗・作業の候補（まずは固定でOK。後でAPI化できます）
  // store_id / store_name は Stores マスタに合わせる
  const STORES = [
    { id: "TEST-01", name: "テスト店舗" }
    // { id:"OSK-A", name:"大阪A店" },
  ];

  // work_code / work_name は Works マスタに合わせる
  const WORKS = [
    { code: "TESTWORK", name: "テスト作業" }
    // { code:"PHO", name:"撮影" },
    // { code:"CLS", name:"清掃" },
  ];
  // ==========================================================

  const el = (id) => document.getElementById(id);

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function initSelects(){
    const storeSel = el("storeSelect");
    storeSel.innerHTML = STORES.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join("");
  }

  function workOptionsHTML(selected){
    return WORKS.map(w => `<option value="${w.code}" ${w.code===selected?"selected":""}>${w.name} (${w.code})</option>`).join("");
  }

  function parseIds(text){
    const lines = text.split(/\n/);
    const ids = [];
    const invalid = []; // {lineNo, value}
    for(let i=0;i<lines.length;i++){
      const raw = lines[i].trim();
      if(!raw) continue; // 空行は無視
      if(/^\d{10}$/.test(raw)){
        ids.push(raw);
      } else {
        invalid.push({ lineNo: i+1, value: raw });
      }
    }
    return { ids, invalid };
  }

  function renderGroup(group){
    const wrapper = document.createElement("div");
    wrapper.className = "card";
    wrapper.dataset.groupId = group.localId;

    wrapper.innerHTML = `
      <div class="row">
        <div>
          <label>作業（work_code）</label>
          <select class="workSelect">${workOptionsHTML(group.work_code)}</select>
        </div>
        <div>
          <label>車種（そのまま保存）</label>
          <input class="carType" placeholder="例：プリウス" value="${group.car_type_text || ""}">
        </div>
      </div>

      <label>ID一覧（1行=1ID / 10桁）</label>
      <textarea class="idText" placeholder="0123456789&#10;0000000001"></textarea>

      <div class="muted small status"></div>

      <div class="actions">
        <button class="btn danger removeBtn" type="button">このグループを削除</button>
      </div>
    `;

    const idText = wrapper.querySelector(".idText");
    idText.value = group.id_text || "";

    // events
    wrapper.querySelector(".workSelect").addEventListener("change", (e)=>{
      group.work_code = e.target.value;
      updateAll();
    });
    wrapper.querySelector(".carType").addEventListener("input", (e)=>{
      group.car_type_text = e.target.value;
      updateAll();
    });
    idText.addEventListener("input", (e)=>{
      group.id_text = e.target.value;
      updateAll();
    });
    wrapper.querySelector(".removeBtn").addEventListener("click", ()=>{
      state.groups = state.groups.filter(g => g.localId !== group.localId);
      updateUI();
    });

    return wrapper;
  }

  const state = {
    lineUserId: null,
    groups: []
  };

  function updateUI(){
    const groupsEl = el("groups");
    groupsEl.innerHTML = "";
    state.groups.forEach(g => groupsEl.appendChild(renderGroup(g)));
    el("groupCount").textContent = String(state.groups.length);
    updateAll();
  }

  function updateAll(){
    // 各グループの検証状態更新
    let totalQty = 0;
    let totalInvalid = 0;
    let allOk = true;

    document.querySelectorAll("#groups .card").forEach(card=>{
      const gid = card.dataset.groupId;
      const g = state.groups.find(x => x.localId === gid);
      const statusEl = card.querySelector(".status");

      const workOk = !!g.work_code;
      const carOk = (g.car_type_text || "").trim().length > 0;
      const { ids, invalid } = parseIds(g.id_text || "");

      totalQty += ids.length;
      totalInvalid += invalid.length;

      const ok = workOk && carOk && ids.length > 0 && invalid.length === 0;
      if(!ok) allOk = false;

      let msg = [];
      msg.push(`ID有効: ${ids.length}件`);
      if(!carOk) msg.push("車種未入力");
      if(ids.length===0) msg.push("ID未入力");
      if(invalid.length>0){
        msg.push(`不正: ${invalid.length}件（例: 行${invalid[0].lineNo}=${invalid[0].value}）`);
      }
      statusEl.innerHTML = ok
        ? `<span class="ok">OK</span> ${msg.join(" / ")}`
        : `<span class="ng">NG</span> ${msg.join(" / ")}`;
    });

    el("summary").textContent = `グループ数: ${state.groups.length} / 合計ID: ${totalQty} / 不正行: ${totalInvalid}`;
    el("submitBtn").disabled = !(state.groups.length>0 && allOk);
  }

  function buildPayload(){
    const work_date = el("workDate").value;
    const store_id = el("storeSelect").value;
    const reporter_line_user_id = state.lineUserId || "UNKNOWN";

    const groups = state.groups.map(g=>{
      const { ids } = parseIds(g.id_text || "");
      return {
        work_code: g.work_code,
        car_type_text: (g.car_type_text || "").trim(),
        ids
      };
    });

    return { work_date, store_id, reporter_line_user_id, groups };
  }

  async function submit(){
    el("submitBtn").disabled = true;
    el("result").textContent = "送信中…";

    const payload = buildPayload();

    const res = await fetch(MAKE_WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json; charset=utf-8" },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    el("result").textContent = `HTTP ${res.status}\n${text}`;

    if(res.ok){
      // 成功したら入力を残す/消すは好み。ここでは残す。
      // state.groups = []; updateUI();
    }
    updateAll();
  }

  function addGroup(){
    const newGroup = {
      localId: crypto.randomUUID(),
      work_code: WORKS[0]?.code || "",
      car_type_text: "",
      id_text: ""
    };
    state.groups.push(newGroup);
    updateUI();
  }

  async function init(){
    initSelects();
    el("workDate").value = todayISO();

    // 初期グループ1つ
    addGroup();

    // LIFF init
    try{
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()){
        liff.login();
        return;
      }
      const profile = await liff.getProfile();
      state.lineUserId = profile.userId;
      el("userInfo").textContent = `LINE userId: ${profile.userId}`;
    } catch(e){
      el("userInfo").textContent = `LIFF未初期化（ブラウザ直開き中の可能性）: ${e.message || e}`;
    }

    el("addGroupBtn").addEventListener("click", addGroup);
    el("submitBtn").addEventListener("click", submit);
    el("closeBtn").addEventListener("click", ()=>{
      if(window.liff && liff.isInClient()) liff.closeWindow();
      else window.close();
    });

    updateAll();
  }

  init();
</script>
</body>
</html>
